#include <WiFi.h>
#include <WebServer.h>
#include <EmonLib.h> // Biblioteca para SCT-013

// ========================
// CONFIGURAÇÕES DE REDE
// ========================
const char* ssid = "oliveira2";          // <-- Troque pelo nome do seu WiFi
const char* password = "3623B217EC";     // <-- Troque pela senha

// ========================
// SENSOR DE CORRENTE
// ========================
EnergyMonitor emon1;         // Instância da EmonLib
const int sensorPin = 32;    // Pino ADC do SCT-013
const double calibrationFactor = 2.79;

// ========================
// SENSOR DE TENSÃO
// ========================
const int tensaoPin = 33;          // Pino do sensor de tensão
const float fatorDivisao = 6.04;    // Divisor resistivo (0–25V -> 0–5V)
double tensaoMedida = 0.0;

// ========================
// ENERGIA E CUSTO
// ========================
const float preco_kWh = 0.80;     // Preço por kWh (R$)
double corrente = 0.0;
double potencia = 0.0;
double energia_kWh = 0.0;
double custo_estimado = 0.0;
double custo_2min = 0.0;          // custo após cada ciclo de 2 minutos

// ========================
// SERVIDOR WEB
// ========================
WebServer server(80);

unsigned long lastSend = 0;
const long intervalo = 1000; // 1 segundo
unsigned long last2minCheck = 0; // último marco de 2 minutos

// ========================
// PÁGINA HTML
// ========================
const char MAIN_page[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Monitor de Energia</title>
</head>
<body>
  <h1>Monitor de Energia</h1>
  <p><strong>Tensão:</strong> <span id="tensao">0</span> V</p>
  <p><strong>Corrente:</strong> <span id="corrente">0</span> A</p>
  <p><strong>Potência:</strong> <span id="potencia">0</span> W</p>
  <p><strong>Energia:</strong> <span id="energia">0</span> kWh</p>
  <p><strong>Custo Atual:</strong> R$ <span id="custo">0</span></p>
  <p><strong>Custo em 2 min:</strong> R$ <span id="custo2">0</span></p>

  <script>
    async function atualizar() {
      let r = await fetch("/dados");
      let data = await r.json();
      document.getElementById("tensao").textContent = data.tensao.toFixed(2);
      document.getElementById("corrente").textContent = data.corrente.toFixed(3);
      document.getElementById("potencia").textContent = data.potencia.toFixed(1);
      document.getElementById("energia").textContent = data.energia.toFixed(6);
      document.getElementById("custo").textContent = data.custo.toFixed(4);
      document.getElementById("custo2").textContent = data.custo2.toFixed(4);
    }
    setInterval(atualizar, 1000);
  </script>
</body>
</html>
)rawliteral";

// ========================
// FUNÇÃO DE LEITURA DA TENSÃO
// ========================
double lerTensao() {
  int leitura = analogRead(tensaoPin);
  double v_adc = (leitura / 4095.0) * 3.3;   // Converte leitura para volts
  double v_real = v_adc * fatorDivisao;      // Ajusta pelo divisor resistivo
  return v_real;
}

// ========================
// HANDLERS DO SERVIDOR
// ========================
void handleRoot() {
  server.send(200, "text/html", MAIN_page);
}

void handleDados() {
  String json = "{";
  json += "\"tensao\": " + String(tensaoMedida, 2) + ",";
  json += "\"corrente\": " + String(corrente, 3) + ",";
  json += "\"potencia\": " + String(potencia, 1) + ",";
  json += "\"energia\": " + String(energia_kWh, 6) + ",";
  json += "\"custo\": " + String(custo_estimado, 4) + ",";
  json += "\"custo2\": " + String(custo_2min, 4);
  json += "}";
  server.send(200, "application/json", json);
}

// ========================
// SETUP
// ========================
void setup() {
  uint64_t chipid = ESP.getEfuseMac();
  Serial.printf("ESP32 Chip ID: %04X%08X\n", 
              (uint16_t)(chipid>>32), (uint32_t)chipid);


  Serial.begin(115200);
  delay(1500);

  // Configuração do sensor de corrente
  emon1.current(sensorPin, calibrationFactor);

  // Conectar ao WiFi
  Serial.println("Conectando ao WiFi...");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado!");
  Serial.print("IP do ESP32: ");
  Serial.println(WiFi.localIP());

  // Configurar rotas do servidor
  server.on("/", handleRoot);
  server.on("/dados", handleDados);

  server.begin();
  Serial.println("Servidor web iniciado");

  last2minCheck = millis(); // marca o início
}

// ========================
// LOOP
// ========================
void loop() {
  server.handleClient();

  if (millis() - lastSend > intervalo) {
    corrente = emon1.calcIrms(1480);     // Corrente RMS
    tensaoMedida = lerTensao();          // Tensão real medida
    potencia = corrente * tensaoMedida;  // Potência em W

    unsigned long tempoDecorrido = intervalo;  // 1000 ms fixos
    energia_kWh += (potencia * tempoDecorrido) / 3600000.0; // kWh
    custo_estimado = energia_kWh * preco_kWh;

    // Verifica a cada 2 minutos (120000 ms)
    if (millis() - last2minCheck >= 120000) {
      custo_2min = custo_estimado; // custo acumulado até agora
      Serial.print(">>> Custo acumulado nos últimos 2 minutos: R$ ");
      Serial.println(custo_2min, 4);
      last2minCheck = millis(); // reinicia o contador
    }

    // Debug no monitor serial
    Serial.print("Tensão: ");
    Serial.print(tensaoMedida, 2);
    Serial.print(" V | Corrente: ");
    Serial.print(corrente, 3);
    Serial.print(" A | Potência: ");
    Serial.print(potencia, 1);
    Serial.print(" W | Energia: ");
    Serial.print(energia_kWh, 6);
    Serial.print(" kWh | Custo: R$ ");
    Serial.println(custo_estimado, 4);

    lastSend = millis();
  }
}
